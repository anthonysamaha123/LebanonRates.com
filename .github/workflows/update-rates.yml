name: Update Exchange Rates

on:
  schedule:
    # Run every 30 minutes (cron syntax: minute hour day month weekday)
    - cron: '*/30 * * * *'
  # Also allow manual triggering
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check last update time
        id: check-time
        run: |
          if [ -f "data/rates.json" ]; then
            LAST_UPDATE=$(stat -f "%Sm" -t "%s" data/rates.json 2>/dev/null || stat -c "%Y" data/rates.json 2>/dev/null || echo "0")
            NOW=$(date +%s)
            AGE=$((NOW - LAST_UPDATE))
            MIN_AGE=60  # Minimum 60 seconds between fetches
            
            if [ $AGE -lt $MIN_AGE ]; then
              echo "⏭ Skipping fetch - data is only $AGE seconds old (minimum $MIN_AGE seconds required)"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "✓ Data is $AGE seconds old, proceeding with fetch"
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "✓ No existing data file, will fetch"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Add small delay to spread requests
        if: steps.check-time.outputs.skip == 'false'
        run: |
          # Add random delay 0-30 seconds to avoid all instances hitting at once
          DELAY=$((RANDOM % 30))
          echo "⏳ Adding ${DELAY}s delay to spread requests..."
          sleep $DELAY
      
      - name: Fetch latest rates
        if: steps.check-time.outputs.skip == 'false'
        run: npm run fetch-data
        continue-on-error: true
      
      - name: Build site
        if: steps.check-time.outputs.skip == 'false' || steps.git-check.outputs.changes == 'true'
        run: npm run build
      
      - name: Check for changes
        id: git-check
        if: steps.check-time.outputs.skip == 'false'
        run: |
          # Force add data/ even if in .gitignore for tracking
          git add -f data/ || true
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -f data/
          # Only add dist/ if it's not in .gitignore, otherwise skip
          git add dist/ 2>/dev/null || echo "dist/ not tracked (in .gitignore)"
          git commit -m "Auto-update: Refresh exchange rates $(date +'%Y-%m-%d %H:%M:%S UTC')" || exit 0
          git push
